% v2 has rho incorporated (for phi equation). Also, several terms in the
% time-stepping equation for psi has been averaged for higher accuracy.

psim1 = psim0; psim0 = psi;
Axm0 = (Ax+Axm1)/2;  Aym0 = (Ay+Aym1)/2;  Azm0 = (Az+Azm1)/2;

psi(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1) = psim1(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1) ...
                            + dt/me*(1i*hbar*((psim0(3:Nx_qd,2:Ny_qd-1,2:Nz_qd-1)-2*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(1:Nx_qd-2,2:Ny_qd-1,2:Nz_qd-1))/dx^2 ...
                                 +(psim0(2:Nx_qd-1,3:Ny_qd,2:Nz_qd-1)-2*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(2:Nx_qd-1,1:Ny_qd-2,2:Nz_qd-1))/dy^2 ...
                                 +(psim0(2:Nx_qd-1,2:Ny_qd-1,3:Nz_qd)-2*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(2:Nx_qd-1,2:Ny_qd-1,1:Nz_qd-2))/dz^2) ...
                            + q*(((psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(3:Nx_qd,2:Ny_qd-1,2:Nz_qd-1))/2.*Axm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1)...
                                 -(psim0(1:Nx_qd-2,2:Ny_qd-1,2:Nz_qd-1)+psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/2.*Axm0(Nxstart:Nxend-2,Nystart+1:Nyend-1,Nzstart+1:Nzend-1))/dx...
                                 +((psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(2:Nx_qd-1,3:Ny_qd,2:Nz_qd-1))/2.*Aym0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1)...
                                 -(psim0(2:Nx_qd-1,1:Ny_qd-2,2:Nz_qd-1)+psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/2.*Aym0(Nxstart+1:Nxend-1,Nystart:Nyend-2,Nzstart+1:Nzend-1))/dy...
                                 +((psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)+psim0(2:Nx_qd-1,2:Ny_qd-1,3:Nz_qd))/2.*Azm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1)...
                                 -(psim0(2:Nx_qd-1,2:Ny_qd-1,1:Nz_qd-2)+psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/2.*Azm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart:Nzend-2))/dz) ...
                            + q*(Axm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).*(psim0(3:Nx_qd,2:Ny_qd-1,2:Nz_qd-1)-psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/dx...
                                 +Aym0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).*(psim0(2:Nx_qd-1,3:Ny_qd,2:Nz_qd-1)-psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/dy...
                                 +Azm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).*(psim0(2:Nx_qd-1,2:Ny_qd-1,3:Nz_qd)-psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))/dz) ...
                            - 1i*q^2/hbar*((Axm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).^2+Axm0(Nxstart:Nxend-2,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).^2 ...
                                 +Aym0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).^2+Aym0(Nxstart+1:Nxend-1,Nystart:Nyend-2,Nzstart+1:Nzend-1).^2 ...
                                 +Azm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).^2+Azm0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart:Nzend-2).^2)/2 ...
                                 .*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1))) ...
                            - 1i*2*dt*q/hbar*(phim0(Nxstart+1:Nxend-1,Nystart+1:Nyend-1,Nzstart+1:Nzend-1).*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)) ...
                            - 1i*2*dt*V(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)/hbar.*psim0(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1);

% These Jq's are on the minus half steps on the next iteration. Currently,
% the most recent Jq being calculated is actually on n+1/2.
psihalf = (psi+psim0)/2;  Jqxm5 = Jqxm3;  Jqxm3 = Jqxm1;  Jqym5 = Jqym3;  Jqym3 = Jqym1;  Jqzm5 = Jqzm3;  Jqzm3 = Jqzm1;
Jqxm1 = -q/me*real(1i*hbar*conj(psihalf(1:Nx_qd-1,1:Ny_qd,1:Nz_qd)).*(psihalf(2:Nx_qd,1:Ny_qd,1:Nz_qd)-psihalf(1:Nx_qd-1,1:Ny_qd,1:Nz_qd))/dx ...
      + q*psihalf(1:Nx_qd-1,1:Ny_qd,1:Nz_qd).*conj(psihalf(1:Nx_qd-1,1:Ny_qd,1:Nz_qd)).*Ax(Nxstart:Nxend-1,Nystart:Nyend,Nzstart:Nzend));
Jqym1 = -q/me*real(1i*hbar*conj(psihalf(1:Nx_qd,1:Ny_qd-1,1:Nz_qd)).*(psihalf(1:Nx_qd,2:Ny_qd,1:Nz_qd)-psihalf(1:Nx_qd,1:Ny_qd-1,1:Nz_qd))/dy ...
      + q*psihalf(1:Nx_qd,1:Ny_qd-1,1:Nz_qd).*conj(psihalf(1:Nx_qd,1:Ny_qd-1,1:Nz_qd)).*Ay(Nxstart:Nxend,Nystart:Nyend-1,Nzstart:Nzend));
Jqzm1 = -q/me*real(1i*hbar*conj(psihalf(1:Nx_qd,1:Ny_qd,1:Nz_qd-1)).*(psihalf(1:Nx_qd,1:Ny_qd,2:Nz_qd)-psihalf(1:Nx_qd,1:Ny_qd,1:Nz_qd-1))/dz ...
      + q*psihalf(1:Nx_qd,1:Ny_qd,1:Nz_qd-1).*conj(psihalf(1:Nx_qd,1:Ny_qd,1:Nz_qd-1)).*Az(Nxstart:Nxend,Nystart:Nyend,Nzstart:Nzend-1));
rho(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1) = rho(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1) ...
                                     - dt*((Jqxm1(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)-Jqxm1(1:Nx_qd-2,2:Ny_qd-1,2:Nz_qd-1))/dx...
                                     +(Jqym1(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)-Jqym1(2:Nx_qd-1,1:Ny_qd-2,2:Nz_qd-1))/dy...
                                     +(Jqzm1(2:Nx_qd-1,2:Ny_qd-1,2:Nz_qd-1)-Jqzm1(2:Nx_qd-1,2:Ny_qd-1,1:Nz_qd-2))/dz);